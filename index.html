<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>sougouyurusumaji</title>
<style>
.example2 {
    width: 50%;
    min-width: 200px;
    max-width: 600px;
    padding: 10px;
    box-sizing: border-box;
    border: 1px solid #68779a;
    background: #cbe8fa;
    cursor: pointer;
}
#roulette {
    font-size: 48px;
    font-weight: bold;
    text-align: center;
    margin-top: 20px;
    opacity: 0;
    transition: opacity 0.3s;
}
</style>
</head>
<body>

<h1>sougouturaiiii</h1>

<img src="https://joyplot.com/documents/wp-content/uploads/2016/08/dice.png" align="right">

<form id="lotteryForm">
    学年：
    <input name="grade" type="number" value="1" min="1" max="6"><br>

    クラス：
    <input name="classroom" type="number" value="1" min="1" max="10"><br>

    人数：
    <input name="number2" type="number" value="40" min="1" max="100"><br>

    <button type="submit" class="example2">抽選開始！</button>
</form>

<hr>

<div id="roulette"></div>
<p id="result"></p>

<hr>

<h3>抽選履歴（全学年クラス）</h3>
<div id="history"></div>

<hr>
<button onclick="resetAll()">全ての履歴をリセット</button>

<script>
function loadHistory() {
    const historyDiv = document.getElementById("history");
    historyDiv.innerHTML = "";
    const data = JSON.parse(localStorage.getItem("history") || "{}");

    const keys = Object.keys(data);
    if (keys.length === 0) {
        historyDiv.innerHTML = "<p>まだ履歴がありません</p>";
        return;
    }

    keys.forEach(key => {
        const h = document.createElement("h4");
        h.innerText = `${key}組`;
        historyDiv.appendChild(h);

        const ul = document.createElement("ul");
        data[key].forEach(num => {
            const li = document.createElement("li");
            li.innerText = `${num}番`;
            ul.appendChild(li);
        });
        historyDiv.appendChild(ul);
    });
}

function resetAll() {
    localStorage.removeItem("history");
    loadHistory();
    alert("全履歴を削除しました！");
}

// 抽選処理
document.getElementById("lotteryForm").addEventListener("submit", e => {
    e.preventDefault();

    const form = new FormData(e.target);
    const grade = form.get("grade");
    const classroom = form.get("classroom");
    const number2 = parseInt(form.get("number2"), 10);

    const key = `${grade}-${classroom}`;
    const data = JSON.parse(localStorage.getItem("history") || "{}");

    if (!data[key]) data[key] = [];

    const allNumbers = [...Array(number2)].map((_, i) => i + 1);
    const used = data[key];
    const remain = allNumbers.filter(n => !used.includes(n));

    if (remain.length === 0) {
        alert(`${grade}年${classroom}組は全て抽選済みです！`);
        return;
    }

    const selected = remain[Math.floor(Math.random() * remain.length)];
    used.push(selected);
    data[key] = used;
    localStorage.setItem("history", JSON.stringify(data));

    const rouletteEl = document.getElementById("roulette");
    const resultEl = document.getElementById("result");

    let current = 1;
    rouletteEl.style.opacity = "1";

    const interval = setInterval(() => {
        current = (current % number2) + 1;
        rouletteEl.innerText = current;
    }, 50);

    setTimeout(() => {
        clearInterval(interval);
        rouletteEl.innerText = selected;
        rouletteEl.style.color = "#c00";
        resultEl.innerText = `結果: ${grade}年${classroom}組 ${selected}番`;
        loadHistory();
    }, 1500);
});

loadHistory();
</script>
</body>
</html>
